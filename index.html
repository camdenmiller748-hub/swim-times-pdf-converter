<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Swim Times PDF Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.344.0/dist/umd/lucide.min.js"></script>

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      --blue: #2563eb;
      --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 40px 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 48px;
      width: 100%;
    }

    h1 { font-size: 32px; font-weight: 800; margin-bottom: 8px; color: #1e293b; }
    .subtitle { color: var(--muted); margin-bottom: 32px; }

    .step { display: flex; gap: 24px; padding: 32px 0; border-top: 1px solid var(--border); }
    .step:first-of-type { border-top: none; }

    .step-num {
      flex: 0 0 auto;
      width: 40px; height: 40px;
      border-radius: 12px;
      background: var(--blue);
      color: #fff;
      font-weight: 700;
      display: flex; align-items: center; justify-content: center;
    }

    .step-body { flex: 1; min-width: 0; }
    .step-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }

    .datepicker-trigger {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      background: white; border: 1px solid var(--border); border-radius: 12px;
      cursor: pointer; font-weight: 600;
    }

    .calendar-card {
      position: absolute; width: 320px; background: white; border: 1px solid var(--border);
      border-radius: 16px; box-shadow: var(--shadow); padding: 20px; z-index: 100;
      display: none; margin-top: 8px;
    }
    .calendar-card.active { display: block; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; margin-top: 10px; }
    .calendar-day { padding: 8px 0; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .calendar-day.selected { background: var(--blue); color: white; }

    .upload-area {
      border: 2px dashed var(--blue); border-radius: 20px; padding: 48px;
      text-align: center; background: #eff6ff; cursor: pointer;
    }

    .status { margin-top: 24px; padding: 16px; border-radius: 12px; display: none; font-weight: 600; }
    .status.success { display: block; background: #f0fdf4; color: #166534; }
    .status.error { display: block; background: #fef2f2; color: #991b1b; }

    textarea { width: 100%; height: 180px; border-radius: 12px; border: 1px solid var(--border); padding: 16px; font-family: monospace; font-size: 12px; background: #f8fafc; margin: 12px 0; }

    .preview-table-container { margin-top: 24px; border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; background: #fff; }
    .preview-table { width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 13px; }
    .preview-table th { background: #1e293b; color: #fff; padding: 12px; text-align: left; }
    .preview-table td { padding: 10px 12px; border-top: 1px solid var(--border); }
    .previous-time { color: #94a3b8; font-style: italic; }

    .button { border: none; border-radius: 10px; padding: 12px 24px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .button.primary { background: #16a34a; color: #fff; }
    .button.secondary { background: #1e293b; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Swim Times PDF Converter</h1>
    <p class="subtitle">Extracting Individual Top Times (V4.4 Professional Engine)</p>

    <div class="step">
      <div class="step-num">1</div>
      <div class="step-body">
        <div class="step-title">Season Start Date</div>
        <div style="position: relative;">
          <button class="datepicker-trigger" id="dateTrigger">
            <i data-lucide="calendar"></i> <span id="dateDisplay">October 30, 2025</span>
          </button>
          <div class="calendar-card" id="calendarCard">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 id="monthYear"></h4>
              <div>
                <button id="prevMonth" style="border:none;background:none;cursor:pointer;padding:5px;"><i data-lucide="chevron-left"></i></button>
                <button id="nextMonth" style="border:none;background:none;cursor:pointer;padding:5px;"><i data-lucide="chevron-right"></i></button>
              </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">2</div>
      <div class="step-body">
        <div class="step-title">Generate PDF in Team Manager</div>
        <div style="border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px;">
          <img src="https://i.imgur.com/25PNf2e.png" style="display: block; width: 100%; height: auto;" alt="Settings" />
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">3</div>
      <div class="step-body">
        <div class="step-title">Upload PDF</div>
        <div class="upload-area" id="uploadArea">
          <i data-lucide="upload-cloud" style="width:48px;height:48px;color:var(--blue);margin-bottom:12px;"></i>
          <div style="font-weight: 800; font-size: 18px;">Click to select file</div>
          <input type="file" id="fileInput" accept=".pdf" style="display: none;" />
        </div>
        <div class="status" id="status"></div>
        <div class="results" id="results" style="display: none;">
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="button primary" onclick="copyToClipboard()"><i data-lucide="copy"></i> Copy Data</button>
            <button class="button secondary" onclick="downloadCSV()"><i data-lucide="download"></i> CSV</button>
          </div>
          <textarea id="dataOutput" readonly></textarea>
          <div class="preview-table-container"><div id="previewContainer"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    let selectedDate = new Date(2025, 9, 30);
    let viewDate = new Date(selectedDate);
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      document.getElementById('monthYear').textContent = `${months[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
      const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
      const last = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
      for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
      for(let i=1; i<=last; i++) {
        const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = i;
        const cur = new Date(viewDate.getFullYear(), viewDate.getMonth(), i);
        if(cur.toDateString() === selectedDate.toDateString()) d.classList.add('selected');
        d.onclick = (e) => { e.stopPropagation(); selectedDate = cur; document.getElementById('dateDisplay').textContent = `${months[cur.getMonth()]} ${cur.getDate()}, ${cur.getFullYear()}`; document.getElementById('calendarCard').classList.remove('active'); renderCalendar(); };
        grid.appendChild(d);
      }
    }

    document.getElementById('dateTrigger').onclick = (e) => { e.stopPropagation(); document.getElementById('calendarCard').classList.toggle('active'); renderCalendar(); };
    document.getElementById('prevMonth').onclick = (e) => { e.stopPropagation(); viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); };
    document.getElementById('nextMonth').onclick = (e) => { e.stopPropagation(); viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); };
    window.onclick = () => document.getElementById('calendarCard').classList.remove('active');

    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    uploadArea.onclick = () => fileInput.click();
    fileInput.onchange = (e) => { if (e.target.files.length) handleFile(e.target.files[0]); };

    function showStatus(msg, type) {
      const s = document.getElementById("status");
      s.style.display = "block"; s.className = "status " + type; s.textContent = msg;
    }

    async function handleFile(file) {
      showStatus("Stitching fragmented PDF data...", "processing");
      document.getElementById("results").style.display = "none";
      try {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        let allLines = [];
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const text = await page.getTextContent();
          const lineMap = {};
          text.items.forEach(item => {
            const y = Math.round(item.transform[5]);
            if (!lineMap[y]) lineMap[y] = [];
            lineMap[y].push(item);
          });
          Object.keys(lineMap).sort((a,b) => b-a).forEach(y => {
            const line = lineMap[y].sort((a,b) => a.transform[4] - b.transform[4]).map(it => it.str).join(" ").replace(/[",]/g, ' ').replace(/\s+/g, ' ').trim();
            if (line) allLines.push(line);
          });
        }
        const data = extractSwimmers(allLines);
        renderData(data);
        showStatus(`Extracted ${data.length} swimmers. Audit complete.`, "success");
      } catch (err) { showStatus("Parser Error: " + err.message, "error"); }
    }

    function extractSwimmers(lines) {
      const swimmers = new Map();
      let currentSwimmer = null;
      
      const teamCodes = new Set();
      lines.forEach(l => {
        const m = l.match(/\[([A-Z0-9\-]{2,10})\]/);
        if(m) teamCodes.add(m[1]);
      });

      const timeRegex = /(x?\d{0,2}\s*:?\s*\d{1,2}\s*\.\s*\d{2})/;
      const dateRegex = /(\d{1,2}\/\d{1,2}\/\d{4})/;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const metadataFound = /\((Yr:|Year:)?\s*[A-Z0-9]+\)|\((\d+)\)|\b([BGMW])\b/gi.test(line);
        const hasTime = timeRegex.test(line);
        const hasDate = dateRegex.test(line);

        // Header Logic: Always check for header info independently
        if (metadataFound) {
          let name = line.replace(/\(.*\)/g, '').replace(/\b[BGMW]\b/g, '').replace(/\[.*\]/g, '').replace(/\s+/g, ' ').trim();
          // Remove any words matching team codes
          teamCodes.forEach(code => name = name.replace(new RegExp(`\\b${code}\\b`, 'gi'), '').trim());
          // Remove trailing school clusters (3-8 uppercase chars)
          name = name.replace(/\s+[A-Z0-9\-]{3,8}$/, '').replace(/\b(Y|SCY|L|S)\b$/i, '').trim();
          // Remove any text that looks like a time to prevent accidental pairing in name column
          name = name.replace(timeRegex, '').replace(dateRegex, '').trim();

          if (name.length > 2) {
            if (!swimmers.has(name)) {
              let g = (line.match(/\b([BGMW])\b/i) || ["","F"])[1].toUpperCase();
              g = (g === 'M' || g === 'B') ? 'M' : 'F';
              swimmers.set(name, { Name: name, Gender: g, "200 FREE": "NT", "200 IM": "NT", "50 FREE": "NT", "100 FLY": "NT", "100 FREE": "NT", "500 FREE": "NT", "100 BACK": "NT", "100 BREAST": "NT" });
            }
            currentSwimmer = swimmers.get(name);
          }
        } 
        
        // Time Logic: Process line if we have a time, regardless of header status
        if (currentSwimmer && hasTime) {
          // Lookahead buffer to pair Distance/Event/Date
          let context = (line + " " + (lines[i+1] || "") + " " + (lines[i+2] || "") + " " + (lines[i+3] || "")).replace(/\s+/g, ' ');
          
          const timeMatch = line.match(timeRegex);
          const dateMatch = context.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
          // STRICT EVENT MATCHING: Distance MUST be followed by Event Name to ignore NISCA points
          const eventMatch = context.match(/\b(50|100|200|500)\b\s*(Free|Back|Breast|Fly|Butterfly|IM|Medley|I\.M\.)/i);

          if (timeMatch && dateMatch && eventMatch) {
            let rawTime = timeMatch[1].replace(/[\s]/g, '').replace(/^x/, '');
            if(!rawTime.includes(':') && rawTime.includes('.')) {
                let p = rawTime.split('.');
                rawTime = p[0].padStart(2, '0') + '.' + p[1];
            }

            const meetDate = new Date(dateMatch[1]);
            const dist = eventMatch[1];
            const type = eventMatch[2].toLowerCase();
            let eventKey = "";

            if (type.includes("free")) { if (["50","100","200","500"].includes(dist)) eventKey = dist + " FREE"; }
            else if (type.includes("back") && dist === "100") eventKey = "100 BACK";
            else if (type.includes("breast") && dist === "100") eventKey = "100 BREAST";
            else if ((type.includes("fly") || type.includes("butterfly")) && dist === "100") eventKey = "100 FLY";
            else if ((type.includes("im") || type.includes("medley") || type.includes("i.m")) && dist === "200") eventKey = "200 IM";

            if (eventKey) {
              if (meetDate >= selectedDate) {
                if (currentSwimmer[eventKey] === "NT" || currentSwimmer[eventKey] === "Previous" || toSec(rawTime) < toSec(currentSwimmer[eventKey])) {
                  currentSwimmer[eventKey] = rawTime;
                }
              } else if (currentSwimmer[eventKey] === "NT") {
                currentSwimmer[eventKey] = "Previous";
              }
            }
          }
        }
      }
      return Array.from(swimmers.values());
    }

    function toSec(t) {
      if (t === "NT" || t === "Previous") return 999999;
      if (t.includes(":")) { const p = t.split(":"); return parseFloat(p[0])*60 + parseFloat(p[1]); }
      return parseFloat(t);
    }

    function renderData(swimmers) {
      const cols = ["Name", "Gender", "200 FREE", "200 IM", "50 FREE", "100 FLY", "100 FREE", "500 FREE", "100 BACK", "100 BREAST"];
      document.getElementById("dataOutput").value = swimmers.map(s => cols.map(c => s[c]).join("\t")).join("\n");
      let h = `<table class="preview-table"><thead><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr></thead><tbody>`;
      swimmers.forEach(s => {
        h += `<tr><td>${s.Name}</td><td>${s.Gender}</td>${cols.slice(2).map(c => `<td class="${s[c]==='Previous'?'previous-time':''}">${s[c]}</td>`).join("")}</tr>`;
      });
      document.getElementById("previewContainer").innerHTML = h + "</tbody></table>";
      document.getElementById("results").style.display = "block";
      lucide.createIcons();
    }

    function copyToClipboard() { const ta = document.getElementById("dataOutput"); ta.select(); document.execCommand('copy'); }
    function downloadCSV() { 
      const csv = document.getElementById("dataOutput").value.replace(/\t/g, ",");
      const a = document.createElement("a"); a.href = window.URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `swim_times.csv`; a.click();
    }
    renderCalendar();
  </script>
</body>
</html>
